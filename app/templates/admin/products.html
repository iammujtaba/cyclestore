{% extends "base.html" %}

{% block title %}Product Image Management - Supreme Cycle & Rickshaw Co.{% endblock %}

{% block head %}
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .upload-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .upload-btn {
            background: #059669;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .upload-btn:hover {
            background: #047857;
        }
        
        .delete-btn {
            background: #dc2626;
            color: white;
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .delete-btn:hover {
            background: #b91c1c;
        }
        
        .success-message {
            background: #d1fae5;
            border: 1px solid #059669;
            color: #059669;
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .error-message {
            background: #fee2e2;
            border: 1px solid #dc2626;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .file-input {
            margin: 0.5rem 0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <h1 class="text-3xl font-bold text-green-800 mb-6">Product Image Management</h1>
    
    <div id="message-container"></div>
    
    <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Bicycles</h2>
        <div class="product-grid">
            {% for bicycle in bicycles %}
            <div class="product-card">
                <img src="{{ bicycle.get_primary_image() }}" 
                     alt="{{ bicycle.name }}" 
                     class="product-image">
                
                <h3 class="font-semibold text-lg text-gray-800">{{ bicycle.name }}</h3>
                <p class="text-gray-600">{{ bicycle.category }} | ₹{{ "{:,.0f}".format(bicycle.price) }}</p>
                
                <div class="upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Upload New Image:
                    </label>
                    <input type="file" 
                           accept="image/*" 
                           class="file-input"
                           onchange="uploadImage(this, 'bicycle', {{ bicycle.id }})">
                    
                    <div class="mt-2">
                        <button onclick="viewImages('bicycle', {{ bicycle.id }})" 
                                class="upload-btn">
                            View All Images
                        </button>
                        <button onclick="deleteImages('bicycle', {{ bicycle.id }})" 
                                class="delete-btn">
                            Delete All
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Accessories</h2>
        <div class="product-grid">
            {% for accessory in accessories %}
            <div class="product-card">
                <img src="{{ accessory.get_primary_image() }}" 
                     alt="{{ accessory.name }}" 
                     class="product-image">
                
                <h3 class="font-semibold text-lg text-gray-800">{{ accessory.name }}</h3>
                <p class="text-gray-600">{{ accessory.category }} | ₹{{ "{:,.0f}".format(accessory.price) }}</p>
                
                <div class="upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Upload New Image:
                    </label>
                    <input type="file" 
                           accept="image/*" 
                           class="file-input"
                           onchange="uploadImage(this, 'accessory', {{ accessory.id }})">
                    
                    <div class="mt-2">
                        <button onclick="viewImages('accessory', {{ accessory.id }})" 
                                class="upload-btn">
                            View All Images
                        </button>
                        <button onclick="deleteImages('accessory', {{ accessory.id }})" 
                                class="delete-btn">
                            Delete All
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
async function uploadImage(input, productType, productId) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch(`/upload-image/${productType}/${productId}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Image uploaded successfully!', 'success');
            // Refresh the page to show the new image
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMessage('Error uploading image: ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('Error uploading image: ' + error.message, 'error');
    }
    
    // Clear the input
    input.value = '';
}

async function viewImages(productType, productId) {
    try {
        const response = await fetch(`/product-images/${productType}/${productId}`);
        const result = await response.json();
        
        if (result.images && result.images.length > 0) {
            let imageList = result.images.map(img => `<img src="${img}" style="max-width: 200px; margin: 10px;">`).join('');
            
            const popup = window.open('', '_blank', 'width=800,height=600');
            popup.document.write(`
                <html>
                    <head><title>Product Images</title></head>
                    <body style="padding: 20px;">
                        <h2>All Images for Product #${productId}</h2>
                        <div>${imageList}</div>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px;">Close</button>
                    </body>
                </html>
            `);
        } else {
            showMessage('No additional images found for this product.', 'info');
        }
    } catch (error) {
        showMessage('Error fetching images: ' + error.message, 'error');
    }
}

async function deleteImages(productType, productId) {
    if (!confirm('Are you sure you want to delete all images for this product?')) {
        return;
    }
    
    try {
        const response = await fetch(`/product-images/${productType}/${productId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Images deleted successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMessage('Error deleting images: ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('Error deleting images: ' + error.message, 'error');
    }
}

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const className = type === 'success' ? 'success-message' : 'error-message';
    
    container.innerHTML = `<div class="${className}">${message}</div>`;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}
</script>
{% endblock %}
